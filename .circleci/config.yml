version: 2.1

jobs:
  build-and-test:                 # actual job to run 
    docker:
      - image: quay.io/nyulibraries/circleci_docker:19.03.13-dc-1.27.4-0   # docker file with docker-compose installed
    working_directory: ~/app      # working directory inside docker image
    steps:
      - checkout                  # checks out github code
      - setup_remote_docker       # sets up docker daemon to run docker commands
      - run:
          command: docker-compose build 
          name: Test


  push_to_quay:                   # push docker image to quay.io
    steps:
      run:
        name: Push Docker To Quay
        command: |
          docker login -u "$QUAY_USERNAME" -p "$QUAY_PASSWORD" quay.io
          docker push quay.io/ym26/simple-http:latest
  

workflows:
  main:
    jobs:
      - build-and-test      # name of the job to reference run
      - push_to_quay        # push image to quay.io 
          

