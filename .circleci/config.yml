version: 2.1

jobs:
  build-and-test:                 # actual job to run 
    docker:
      - image: quay.io/nyulibraries/circleci_docker:19.03.13-dc-1.27.4-0   # docker file with docker-compose installed
    working_directory: ~/app      # working directory inside docker image
    steps:
      - checkout                  # checks out github code
      - setup_remote_docker       # sets up docker daemon to run docker commands
      - run:
          command: docker-compose build 
          name: Test

  auth_quay:                       # authenticate to quay.io
    run:
      name: Authenticate with Quay
      command: |
        docker login -u "$QUAY_USERNAME" --password "$QUAY_PASSWORD" quay.io


  push_to_quay:                   # push docker image to quay.io
    run:
      name: Push Docker To Quay
      command: |
        docker push quay.io/ym26/simple-http:latest
  

workflows:
  main:
    jobs:
      requires:
      - build-and-test      # name of the job to reference run
      - auth_quay           # authenticate to quay.io
      - push_to_quay        # push image to quay.io
          

